* redis_connection_manager
:PROPERTIES:
:CUSTOM_ID: redis_connection_manager
:END:
#+begin_example
redis-server redis.conf

cargo run
#+end_example

* Docker 启动 Redis Raft 集群
- 默认镜像 `redis:8.4-alpine` 假设已内置 RAFT，直接启动 3 节点集群：
  #+begin_example
  ./scripts/start_redis_raft_cluster.sh
  #+end_example
- 若需要手动加载 `redisraft.so`（自带镜像或本地文件），设置 `ENABLE_REDISRAFT_MODULE=1`：本地 so 用 `REDISRAFT_SO=./redisraft.so`，镜像自带则加 `USE_IMAGE_REDISRAFT=1` 并可用 `CONTAINER_MODULE_PATH` 指定路径。模块模式下会为三个节点配置 `raft-addr` 5001/5002/5003，`PUBLISH_RAFT_PORTS=1` 可暴露到宿主机。
- 默认端口/密码：Redis 6379/6380/6381，密码 `abc123`。可通过环境变量覆盖，例如：
  #+begin_example
  IMAGE_NAME=my-raft REDIS_PASSWORD=secret ./scripts/start_redis_raft_cluster.sh
  #+end_example
- 如之前 export 过 `IMAGE_NAME`（例如 `redis:8.4-alpine`），运行前可以 `unset IMAGE_NAME`，或显式指定 `IMAGE_NAME=redis:8.4-alpine ./scripts/start_redis_raft_cluster.sh`。
- 集群创建完成后，可验证：
  #+begin_example
  redis-cli -a abc123 -p 6379 RAFT.INFO
  #+end_example

* Redis Raft 集群快速启动
- 在仓库根目录放置编译好的 `redisraft.so`，保持 `redis.conf` 中的路径 `./redisraft.so` 可用。
- 为每个节点准备独立的配置，调整端口、Raft 地址和数据目录，例如：
  - 节点1：使用默认 `redis.conf`（端口6379，Raft 127.0.0.1:5001，数据目录 `data/node1`）。
  - 节点2：复制 `redis.conf` 为 `redis-node2.conf`，修改为端口6380，`loadmodule ./redisraft.so ... raft-addr 127.0.0.1:5002`，`dir ./data/node2`，`pidfile ./data/node2/redis_6380.pid`，`logfile "./data/node2/redis.log"`。
  - 节点3：同理创建 `redis-node3.conf`，端口6381，`raft-addr 127.0.0.1:5003`，`dir ./data/node3` 等。
- 启动各节点：`redis-server redis.conf`、`redis-server redis-node2.conf`、`redis-server redis-node3.conf`。
- 组成集群（在节点1上创建，其余节点加入）：
  #+begin_example
  redis-cli -a abc123 -p 6379 RAFT.CLUSTER CREATE
  redis-cli -a abc123 -p 6380 RAFT.CLUSTER JOIN 127.0.0.1:6379
  redis-cli -a abc123 -p 6381 RAFT.CLUSTER JOIN 127.0.0.1:6379
  #+end_example
- 验证：`redis-cli -a abc123 -p 6379 RAFT.INFO`，看到 state=Leader 且有 3 个节点即成功。

* Valkey Cluster Dockerfile
- 镜像 `docker/valkey-cluster.Dockerfile` 基于官方 `valkey/valkey:7.2-alpine`，入口脚本自动生成 cluster 配置（启用 cluster、设置 announce 端口、可选密码），与 https://valkey.io/topics/migration/ 和 https://valkey.io/topics/cluster-tutorial/ 的配置一致。
- 构建镜像：
  #+begin_example
  docker build -f docker/valkey-cluster.Dockerfile -t valkey-cluster .
  #+end_example
- 示例：在同一网络启动 6 个节点（3 主 3 从），统一密码 `abc123`。如果宿主机已经占用了 6379/6380/6381 等端口，请改用其他宿主机端口（下例用 7001 起始）：
  #+begin_example
  docker network create valkey-net
  BASE_PORT=7000 # 宿主机映射起始（7001..7006、17001..17006）
  for i in 1 2 3 4 5 6; do
    port=$((BASE_PORT + i))
    bus=$((port + 10000))
    docker run -d --name valkey-$i --net valkey-net \
      -p ${port}:${port} -p ${bus}:${bus} \
      -e NODE_ID=$i \
      -e VALKEY_PORT=${port} \
      -e VALKEY_PASSWORD=abc123 \
      -e CLUSTER_ANNOUNCE_IP=valkey-$i \
      valkey-cluster
  done
  # 若仅容器互通，不需要暴露到宿主机，可去掉 -p 映射。
  #+end_example
- 组成集群（3 主 3 从）：
  #+begin_example
  docker exec -it valkey-1 valkey-cli -a abc123 --cluster create \
    valkey-1:7001 valkey-2:7002 valkey-3:7003 valkey-4:7004 valkey-5:7005 valkey-6:7006 \
    --cluster-replicas 1 --cluster-yes
  #+end_example
- 验证：
  #+begin_example
  # 根据启动时的 VALKEY_PORT 连接（例：7001）
  docker exec -it valkey-1 valkey-cli -a abc123 -p 7001 cluster info
  docker exec -it valkey-1 valkey-cli -a abc123 -p 7001 cluster nodes
  #+end_example
